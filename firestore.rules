rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function: Check if user document exists and get role
    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    // Check if user is admin
    function isAdmin() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        getUserData().role == 'admin';
    }

    // Check if user is an approved driver
    function isApprovedDriver() {
      return request.auth != null &&
        exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
        getUserData().isApprovedDriver == true;
    }

    // Get user's driverId
    function getUserDriverId() {
      return getUserData().driverId;
    }

    // ==================== VEHICLES ====================
    // Public read, authenticated write
    match /vehicles/{vehicleId} {
      allow read: if true;
      allow write: if request.auth != null;
    }

    // ==================== BOOKINGS ====================
    match /bookings/{bookingId} {
      // Anyone authenticated can create a booking
      allow create: if request.auth != null;

      // Read: owner, admin, or ASSIGNED driver only
      // FIX: Driver can only read bookings assigned to them (privacy protection)
      allow read: if request.auth != null && (
        // Booking owner
        resource.data.userId == request.auth.uid ||
        // Admin can read all
        isAdmin() ||
        // Driver can ONLY read their assigned bookings
        (isApprovedDriver() &&
         resource.data.driver != null &&
         resource.data.driver.driverId == getUserDriverId())
      );

      // Update: owner, admin, or assigned driver
      allow update: if request.auth != null && (
        // Booking owner
        resource.data.userId == request.auth.uid ||
        // Admin can update any booking
        isAdmin() ||
        // Approved driver can update their assigned bookings
        (isApprovedDriver() &&
         resource.data.driver != null &&
         resource.data.driver.driverId == getUserDriverId())
      );

      // List: admin or approved driver (documents still need to pass read rule)
      allow list: if request.auth != null && (isAdmin() || isApprovedDriver());

      // Delete: admin only
      allow delete: if isAdmin();
    }

    // ==================== USERS ====================
    match /users/{userId} {
      // User can read own document, admin can read all
      allow read: if request.auth != null && (
        request.auth.uid == userId || isAdmin()
      );

      // PROTECTED FIELDS - only changeable via Firebase Admin SDK (server-side)
      // - role: admin/user status
      // - isApprovedDriver: driver approval status

      // Create: user can create own document (but cannot set protected fields)
      allow create: if request.auth != null &&
        request.auth.uid == userId &&
        (!request.resource.data.keys().hasAny(['role']) || request.resource.data.role != 'admin') &&
        !request.resource.data.keys().hasAny(['isApprovedDriver']);

      // Update: user can update own document BUT CANNOT change protected fields
      // Admin can update any document BUT CANNOT change role (only Super Admin via API)
      allow update: if request.auth != null && (
        // User updating own document - cannot modify protected fields
        (request.auth.uid == userId &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role', 'isApprovedDriver'])) ||
        // Admin updating any document - cannot modify role field (must use API)
        // But admin CAN modify isApprovedDriver
        (isAdmin() &&
         !request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']))
      );

      // Delete: admin only
      allow delete: if isAdmin();

      // Subcollections
      match /{subcollection}/{docId} {
        allow read, write: if request.auth != null && (
          request.auth.uid == userId || isAdmin()
        );
      }
    }

    // ==================== DRIVERS ====================
    match /drivers/{driverId} {
      // Any authenticated user can read (for admin to see driver list)
      allow read: if request.auth != null;

      // Driver can update their own document, admin can do anything
      allow update: if request.auth != null && (
        isAdmin() ||
        (isApprovedDriver() && getUserDriverId() == driverId)
      );

      // Only admin can create or delete drivers
      allow create, delete: if isAdmin();
    }

    // ==================== LOCATIONS & ROUTES ====================
    match /locations/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    match /routes/{document=**} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==================== VOUCHERS ====================
    match /vouchers/{voucherId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // ==================== SETTINGS ====================
    match /settings/{document=**} {
      allow read: if request.auth != null;
      allow write: if isAdmin();
    }

    // ==================== NOTIFICATIONS ====================
    match /notifications/{notificationId} {
      // User can read their own, admin can read all
      allow read: if request.auth != null && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      // User can create for themselves, admin can create for anyone
      allow create: if request.auth != null && (
        request.resource.data.userId == request.auth.uid || isAdmin()
      );
      // User can update/delete their own, admin can do anything
      allow update, delete: if request.auth != null && (
        resource.data.userId == request.auth.uid || isAdmin()
      );
      // List: authenticated users
      allow list: if request.auth != null;
    }

    // ==================== ADMIN NOTIFICATIONS ====================
    match /admin_notifications/{notificationId} {
      allow read, update, delete, list: if isAdmin();
      allow create: if request.auth != null;
    }

    // ==================== STRIPE CUSTOMERS ====================
    match /customers/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;

      match /{subcollection}/{docId} {
        allow read, write: if request.auth != null && request.auth.uid == userId;
      }
    }
  }
}
